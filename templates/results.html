{% extends "base.html" %}

{% block title %}Scan Results - Derme{% endblock %}

{% block content %}
<div class="results-page">
    <h1>Scan Results</h1>
    
    <div class="results-summary">
        {% set allergen_count = results.analysis.allergens_found|length %}
        {% set warning_count = results.analysis.warnings|length %}
        {% set safe_count = results.analysis.safe_ingredients|length %}
        
        <div class="summary-card {% if allergen_count > 0 %}alert-danger{% else %}alert-success{% endif %}">
            {% if allergen_count > 0 %}
                <h2>‚ö†Ô∏è Warning: Allergens Detected</h2>
                <p>This product contains {{ allergen_count }} ingredient(s) you're allergic to.</p>
            {% else %}
                <h2>‚úÖ Safe to Use</h2>
                <p>No known allergens detected in this product.</p>
            {% endif %}
        </div>
        
        <div class="stats-grid">
            <div class="stat-card stat-danger">
                <div class="stat-number">{{ allergen_count }}</div>
                <div class="stat-label">Your Allergens</div>
            </div>
            <div class="stat-card stat-warning">
                <div class="stat-number">{{ warning_count }}</div>
                <div class="stat-label">Common Allergens</div>
            </div>
            <div class="stat-card stat-success">
                <div class="stat-number">{{ safe_count }}</div>
                <div class="stat-label">Safe Ingredients</div>
            </div>
        </div>
    </div>
    
    {% if results.analysis.allergens_found %}
    <div class="results-section danger">
        <h2>‚ö†Ô∏è Your Allergens Found</h2>
        <div class="ingredient-list">
            {% for allergen in results.analysis.allergens_found %}
                <div class="ingredient-item allergen-item">
                    <div>
                        <span class="ingredient-name">{{ allergen.name }}</span>
                        <span class="severity-badge severity-{{ allergen.severity }}">
                            {{ allergen.severity }}
                        </span>
                        <button class="info-btn" onclick="getAllergenInfo('{{ allergen.name }}')">‚ÑπÔ∏è More Info</button>
                    </div>
                    {% if allergen.gemini_explanation %}
                    <p class="ingredient-description gemini-insight">
                        <strong>AI Insight:</strong> {{ allergen.gemini_explanation }}
                    </p>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    {% if results.analysis.warnings %}
    <div class="results-section warning">
        <h2>‚ö° Common Allergens Detected</h2>
        <div class="ingredient-list">
            {% for warning in results.analysis.warnings %}
                <div class="ingredient-item warning-item">
                    <div>
                        <span class="ingredient-name">{{ warning.name }}</span>
                        <span class="category-badge">{{ warning.category }}</span>
                    </div>
                    <p class="ingredient-description">{{ warning.description }}</p>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    {% if results.analysis.potential_allergens %}
    <div class="results-section warning">
        <h2>üî¨ Potential Allergens (Based on Your History)</h2>
        <p style="margin-bottom: 1rem;">These ingredients appear in products you reacted to but not in products that were safe for you.</p>
        <div class="ingredient-list">
            {% for potential in results.analysis.potential_allergens %}
                <div class="ingredient-item warning-item">
                    <div>
                        <span class="ingredient-name">{{ potential.name }}</span>
                    </div>
                    <p class="ingredient-description">{{ potential.reason }}</p>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    {% if results.analysis.safe_ingredients %}
    <div class="results-section success">
        <h2>‚úÖ Safe Ingredients</h2>
        <div class="ingredient-grid">
            {% for ingredient in results.analysis.safe_ingredients %}
                <div class="ingredient-chip">{{ ingredient }}</div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <div class="detected-ingredients">
        <h3>All Detected Ingredients ({{ results.ingredients|length }})</h3>
        <div class="ingredient-grid">
            {% for ingredient in results.ingredients %}
                <div class="ingredient-chip">{{ ingredient }}</div>
            {% endfor %}
        </div>
    </div>
    
    <div class="action-buttons">
        <div class="save-product-section">
            <form method="POST" action="{{ url_for('save_product') }}" id="saveForm">
                <input type="text" name="product_name" placeholder="Product name (required)" class="inline-input" required>
                <input type="hidden" name="product_type" id="productType" value="safe">
                <input type="hidden" name="reaction_severity" id="reactionSeverity" value="unknown">
                
                <div class="save-buttons">
                    <button type="button" onclick="saveAs('safe')" class="btn btn-success">‚úÖ Save as Safe</button>
                    <button type="button" onclick="saveAs('allergic')" class="btn btn-danger">‚ö†Ô∏è Save as Allergic</button>
                </div>
                
                <div id="severitySelector" style="display: none; margin-top: 1rem;">
                    <label for="severity">Reaction Severity:</label>
                    <select id="severity" onchange="document.getElementById('reactionSeverity').value = this.value">
                        <option value="unknown">Unknown</option>
                        <option value="mild">Mild</option>
                        <option value="moderate">Moderate</option>
                        <option value="severe">Severe</option>
                    </select>
                    <button type="submit" class="btn btn-danger">Confirm Save as Allergic</button>
                </div>
            </form>
        </div>
        <a href="{{ url_for('scan') }}" class="btn btn-secondary">Scan Another Product</a>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
    </div>
    
    {% if results.ocr_method %}
    <div class="ocr-info">
        <small>Scanned using: {{ results.ocr_method }}</small>
    </div>
    {% endif %}
    
    <!-- Allergen Info Modal -->
    <div id="allergenInfoModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeAllergenModal()">&times;</span>
            <h2 id="modalTitle">Loading...</h2>
            <div id="modalBody">
                <div class="loading">Loading allergen information...</div>
            </div>
        </div>
    </div>
    
    <script>
    function saveAs(type) {
        document.getElementById('productType').value = type;
        if (type === 'safe') {
            document.getElementById('severitySelector').style.display = 'none';
            document.getElementById('saveForm').submit();
        } else {
            document.getElementById('severitySelector').style.display = 'block';
        }
    }
    
    function getAllergenInfo(ingredientName) {
        const modal = document.getElementById('allergenInfoModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        
        modal.style.display = 'block';
        modalTitle.textContent = ingredientName;
        modalBody.innerHTML = '<div class="loading">Loading allergen information...</div>';
        
        fetch(`/api/allergen-info/${encodeURIComponent(ingredientName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.info) {
                    let html = '<div class="allergen-details">';
                    
                    if (data.info.alternative_names && data.info.alternative_names.length > 0) {
                        html += '<h3>Alternative Names:</h3>';
                        html += '<div class="ingredient-grid">';
                        data.info.alternative_names.forEach(name => {
                            html += `<div class="ingredient-chip">${name}</div>`;
                        });
                        html += '</div>';
                    }
                    
                    if (data.info.category) {
                        html += `<h3>Category:</h3><p>${data.info.category}</p>`;
                    }
                    
                    if (data.info.allergen_potential) {
                        html += `<h3>Allergen Potential:</h3><p class="allergen-potential allergen-${data.info.allergen_potential}">${data.info.allergen_potential}</p>`;
                    }
                    
                    if (data.info.description) {
                        html += `<h3>Description:</h3><p>${data.info.description}</p>`;
                    }
                    
                    if (data.info.common_in && data.info.common_in.length > 0) {
                        html += '<h3>Commonly Found In:</h3><ul>';
                        data.info.common_in.forEach(product => {
                            html += `<li>${product}</li>`;
                        });
                        html += '</ul>';
                    }
                    
                    html += `<p class="info-source"><em>Information source: ${data.source}</em></p>`;
                    html += '</div>';
                    
                    modalBody.innerHTML = html;
                } else {
                    modalBody.innerHTML = '<p class="error">No additional information available for this ingredient.</p>';
                }
            })
            .catch(error => {
                modalBody.innerHTML = '<p class="error">Error loading allergen information. Please try again.</p>';
                console.error('Error:', error);
            });
    }
    
    function closeAllergenModal() {
        document.getElementById('allergenInfoModal').style.display = 'none';
    }
    
    // Close modal when clicking outside of it
    window.onclick = function(event) {
        const modal = document.getElementById('allergenInfoModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
    </script>
</div>
{% endblock %}
